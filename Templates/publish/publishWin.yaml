---
parameters:
  - name: buildType
    default: 'c'

steps:
  - powershell: |
      $api = "$(Build.Repository.Name)"
      $repo = "perto-${{ parameters.buildType }}"
      $authInfo = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("$(nexusUser):$(nexusPass)"))
      $file32 = "$(Build.SourcesDirectory)\Trunk\C-Fontes\bin\Windows\Release\x86\*"
      $file64 = "$(Build.SourcesDirectory)\Trunk\C-Fontes\bin\Windows\Release\x64\*"
 
      # Usar loop para tratar múltiplos arquivos, já que -InFile não suporta wildcard (*.dll)
      Get-ChildItem -Path $file32 | ForEach-Object {
          Invoke-WebRequest -Uri "$(nexusHost)/repository/$repo/$api/x86/$($_.Name)" -Method Put -Headers @{
              Authorization = "Basic $authInfo"
          } -InFile $_.FullName -UseBasicParsing
      }
       
      Get-ChildItem -Path $file64 | ForEach-Object {
          Invoke-WebRequest -Uri "$(nexusHost)/repository/$repo/$api/x64/$($_.Name)" -Method Put -Headers @{
              Authorization = "Basic $authInfo"
          } -InFile $_.FullName -UseBasicParsing
      }
    displayName: 'Deploy to Nexus'
